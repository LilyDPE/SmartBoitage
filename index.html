<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="theme-color" content="#667eea">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DPE Pro">
    <title>DPE Prospection Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f7;
            overflow-x: hidden;
            padding-bottom: 70px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 20px 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 700;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .header-user {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .user-info {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .container {
            padding: 15px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .search-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        .label-help {
            font-weight: 400;
            color: #666;
            font-size: 0.85em;
            margin-top: 3px;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            font-size: 16px;
            background: #f9f9f9;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
            display: inline-flex;
        }

        .btn-geo {
            background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 201, 255, 0.3);
            margin-bottom: 15px;
        }

        .geo-options {
            display: none;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .geo-options.active {
            display: block;
        }

        .radius-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .radius-btn {
            padding: 8px 15px;
            border: 2px solid #e5e5ea;
            border-radius: 20px;
            background: white;
            color: #666;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radius-btn.active {
            border-color: #00c9ff;
            background: #00c9ff;
            color: white;
        }

        .geo-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #1976d2;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .results-header h3 {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .stat-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .dpe-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            border-left: 4px solid #667eea;
            position: relative;
        }

        .dpe-card.has-note {
            border-left-color: #38ef7d;
        }

        .dpe-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 10px;
        }

        .dpe-address {
            font-weight: 600;
            font-size: 1.05em;
            color: #1d1d1f;
            flex: 1;
        }

        .dpe-city {
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
            margin-top: 5px;
        }

        .dpe-insee {
            font-size: 0.75em;
            color: #999;
            font-weight: 500;
            margin-top: 3px;
            font-family: monospace;
        }

        .dpe-distance {
            font-size: 0.85em;
            color: #00c9ff;
            font-weight: 600;
            margin-top: 3px;
        }

        .classe-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1em;
            flex-shrink: 0;
        }

        .classe-A { background: #00a651; color: white; }
        .classe-B { background: #50b748; color: white; }
        .classe-C { background: #c8d200; color: white; }
        .classe-D { background: #fef200; color: black; }
        .classe-E { background: #fdb913; color: black; }
        .classe-F { background: #f36e21; color: white; }
        .classe-G { background: #e31e24; color: white; }
        .classe-NA { background: #999; color: white; }

        .dpe-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
            font-size: 0.9em;
        }

        .info-item {
            color: #666;
        }

        .info-item strong {
            color: #333;
        }

        .dpe-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e5ea;
        }

        .status-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .status-btn {
            padding: 6px 12px;
            border: 2px solid #e5e5ea;
            border-radius: 20px;
            background: white;
            color: #666;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .status-btn.visited { border-color: #38ef7d; color: #38ef7d; }
        .status-btn.visited.active { background: #38ef7d; color: white; }
        .status-btn.interested { border-color: #fdb913; color: #fdb913; }
        .status-btn.interested.active { background: #fdb913; color: white; }
        .status-btn.not-interested { border-color: #e31e24; color: #e31e24; }
        .status-btn.not-interested.active { background: #e31e24; color: white; }

        .note-section {
            margin-top: 10px;
        }

        .note-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e5ea;
            border-radius: 10px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }

        .modelo-btn {
            background: linear-gradient(135deg, #764ba2 0%, #f5576c 100%);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
            color: #8e8e93;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-icon {
            font-size: 1.5em;
            display: block;
            margin-bottom: 3px;
        }

        .nav-label {
            font-size: 0.7em;
            font-weight: 500;
        }

        .nav-badge {
            position: absolute;
            top: 2px;
            right: 50%;
            transform: translateX(12px);
            background: #e31e24;
            color: white;
            font-size: 0.6em;
            padding: 2px 4px;
            border-radius: 8px;
            min-width: 14px;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            font-size: 1.5em;
            box-shadow: 0 4px 20px rgba(17, 153, 142, 0.4);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99;
        }

        .fab.show {
            display: flex;
        }

        .fab:active {
            transform: scale(0.95);
        }

        .route-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .route-card h4 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .address-count {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            margin-left: 5px;
        }

        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .filter-section h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1em;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            border: 2px solid #e5e5ea;
            border-radius: 20px;
            background: white;
            color: #666;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .surface-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .surface-btn {
            padding: 6px 12px;
            border: 2px solid #e5e5ea;
            border-radius: 20px;
            background: white;
            color: #666;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .surface-btn.active {
            border-color: #11998e;
            background: #11998e;
            color: white;
        }

        .progress-bar {
            background: #e5e5ea;
            border-radius: 10px;
            height: 8px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        @media (max-width: 375px) {
            .dpe-info {
                grid-template-columns: 1fr;
            }
        }

        /* Styles pour la carte */
        #map {
            height: 500px;
            width: 100%;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .map-controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .map-controls h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .zone-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            border-left: 4px solid #11998e;
        }

        .zone-suggestion {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
        }

        .zone-suggestion h5 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .city-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .city-input-group input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè† DPE Pro</h1>
        <p>Prospection avec Code INSEE</p>
        <div class="header-user">
            <span class="user-info" id="userInfo">üë§ Chargement...</span>
            <button class="btn-logout" onclick="logout()">üö™ D√©connexion</button>
        </div>
    </div>

    <!-- Screen 1: Recherche -->
    <div class="screen active" id="searchScreen">
        <div class="container">
            <div class="search-card">
                <!-- Bouton de g√©olocalisation -->
                <button class="btn btn-geo" onclick="toggleGeoSearch()">
                    üìç Rechercher autour de moi
                </button>

                <!-- Options de g√©olocalisation -->
                <div class="geo-options" id="geoOptions">
                    <label>Rayon de recherche</label>
                    <div class="radius-buttons">
                        <button class="radius-btn" onclick="selectRadius(0.1)">100m</button>
                        <button class="radius-btn" onclick="selectRadius(0.5)">500m</button>
                        <button class="radius-btn active" onclick="selectRadius(1)">1 km</button>
                        <button class="radius-btn" onclick="selectRadius(5)">5 km</button>
                        <button class="radius-btn" onclick="selectRadius(10)">10 km</button>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="searchByGeolocation()">
                        üéØ Lancer la recherche g√©olocalis√©e
                    </button>
                    <div class="geo-info" id="geoInfo" style="display: none;"></div>
                </div>

                <div style="text-align: center; margin: 15px 0; color: #999; font-size: 0.9em;">
                    OU
                </div>

                <div class="form-group">
                    <label for="codePostal">
                        üìç Code(s) Postal(aux)
                        <div class="label-help">Entrez plusieurs codes postaux s√©par√©s par des virgules (ex: 76260, 76600, 76000)</div>
                    </label>
                    <input type="text" id="codePostal" value="76260" placeholder="Ex: 76260, 76600, 76000">
                </div>

                <div class="form-group">
                    <label for="annee">üìÖ Ann√©e</label>
                    <select id="annee">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mois">üóìÔ∏è Mois (optionnel)</label>
                    <select id="mois">
                        <option value="">Tous les mois</option>
                        <option value="01">Janvier</option>
                        <option value="02">F√©vrier</option>
                        <option value="03">Mars</option>
                        <option value="04">Avril</option>
                        <option value="05">Mai</option>
                        <option value="06">Juin</option>
                        <option value="07">Juillet</option>
                        <option value="08">Ao√ªt</option>
                        <option value="09">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">D√©cembre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="classeFilter">‚ö° Classe √©nerg√©tique (optionnel)</label>
                    <select id="classeFilter">
                        <option value="">Toutes les classes</option>
                        <option value="F,G">F et G uniquement</option>
                        <option value="E,F,G">E, F et G</option>
                        <option value="A,B,C">A, B et C</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="searchDPE()">
                    üîç Rechercher les DPE
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Recherche en cours...</p>
                <p style="font-size: 0.9em; margin-top: 10px; color: #667eea;">R√©cup√©ration des noms de communes...</p>
            </div>
        </div>
    </div>

    <!-- Screen 2: R√©sultats -->
    <div class="screen" id="resultsScreen">
        <div class="container">
            <div class="results-header" id="resultsHeader"></div>
            
            <!-- Filtres par ville -->
            <div class="filter-section" id="cityFilterSection" style="display: none;">
                <h4>üèôÔ∏è Filtrer par commune</h4>
                <div class="filter-buttons" id="cityFilters"></div>
            </div>

            <!-- Filtres par surface -->
            <div class="filter-section" id="surfaceFilterSection" style="display: none;">
                <h4>üìê Filtrer par surface</h4>
                <div class="surface-filter">
                    <button class="surface-btn active" onclick="filterBySurface('all')">
                        Toutes
                    </button>
                    <button class="surface-btn" onclick="filterBySurface('0-50')">
                        &lt; 50m¬≤
                    </button>
                    <button class="surface-btn" onclick="filterBySurface('50-100')">
                        50-100m¬≤
                    </button>
                    <button class="surface-btn" onclick="filterBySurface('100-150')">
                        100-150m¬≤
                    </button>
                    <button class="surface-btn" onclick="filterBySurface('150-999')">
                        &gt; 150m¬≤
                    </button>
                </div>
            </div>

            <!-- Filtres par rue -->
            <div class="filter-section" id="filterSection" style="display: none;">
                <label for="streetSelect">üèòÔ∏è Filtrer par rue</label>
                <select id="streetSelect" onchange="filterByStreet(this.value)">
                    <option value="">Toutes les rues</option>
                </select>
            </div>
            
            <div id="resultsList"></div>
        </div>
    </div>

    <!-- Screen 3: Itin√©raire -->
    <div class="screen" id="routeScreen">
        <div class="container">
            <div class="empty-state" id="emptyRoute">
                <div class="empty-icon">üó∫Ô∏è</div>
                <h3>Aucun itin√©raire</h3>
                <p>Recherchez d'abord des DPE</p>
            </div>
            <div id="routeContent" style="display: none;">
                <div class="route-card">
                    <h4>üìä R√©capitulatif</h4>
                    <p><strong id="routeTotal">0</strong> adresses √† visiter</p>
                    <p style="margin-top: 10px; color: #666; font-size: 0.9em;" id="routeInfo"></p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="routeProgress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="alert" id="routeAlert" style="display: none;">
                    ‚ö†Ô∏è Google Maps limite √† 10 destinations.<br>
                    Je vais cr√©er plusieurs itin√©raires optimis√©s !
                </div>

                <div class="route-card">
                    <h4>üöó Actions rapides</h4>
                    <button class="btn btn-success" style="margin-bottom: 10px;" onclick="openAllRoutes()">
                        Ouvrir dans Google Maps
                    </button>
                    <button class="btn btn-warning" onclick="sendAllToModelo()">
                        üìã Copier tout pour Modelo
                    </button>
                </div>

                <div id="routeLinks"></div>
            </div>
        </div>
    </div>

    <!-- Screen 4: Mes Notes -->
    <div class="screen" id="notesScreen">
        <div class="container">
            <div class="results-header">
                <h3>üìù Mes Notes Sauvegard√©es</h3>
                <p id="notesCount">0 adresse(s) avec des notes</p>
                <div class="action-buttons">
                    <button class="btn btn-small btn-success" onclick="exportAllNotes()">
                        üì• Export CSV
                    </button>
                    <button class="btn btn-small btn-warning" onclick="clearAllNotes()">
                        üóëÔ∏è Effacer tout
                    </button>
                </div>
            </div>

            <div class="filter-section">
                <h4>Filtrer par statut</h4>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterNotes('')">
                        Toutes
                    </button>
                    <button class="filter-btn" onclick="filterNotes('to-visit')">
                        üìç √Ä visiter
                    </button>
                    <button class="filter-btn" onclick="filterNotes('visited')">
                        ‚úÖ Visit√©
                    </button>
                    <button class="filter-btn" onclick="filterNotes('interested')">
                        ‚≠ê Int√©ress√©
                    </button>
                    <button class="filter-btn" onclick="filterNotes('not-interested')">
                        ‚ùå Pas int√©ress√©
                    </button>
                </div>
            </div>

            <div class="search-card">
                <input type="text" id="notesSearch" placeholder="üîç Rechercher dans les notes..."
                       oninput="searchNotes(this.value)">
            </div>

            <div id="notesList">
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <h3>Aucune note</h3>
                    <p>Vos notes appara√Ætront ici</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen 5: Zones Smart -->
    <div class="screen" id="zonesScreen">
        <div class="container">
            <div class="results-header">
                <h3>üó∫Ô∏è Zones Smart</h3>
                <p>Cr√©ez et optimisez vos zones de prospection</p>
            </div>

            <!-- Carte interactive -->
            <div id="map"></div>

            <!-- Contr√¥les de la carte -->
            <div class="map-controls">
                <h4>üéØ Outils</h4>
                <button class="btn btn-primary" onclick="startDrawing()" style="margin-bottom: 10px;">
                    ‚úèÔ∏è Dessiner une zone
                </button>
                <button class="btn btn-success" onclick="optimizeCurrentZone()" style="margin-bottom: 10px;">
                    ‚ö° Optimiser la zone
                </button>
                <button class="btn btn-warning" onclick="showCityDivision()" style="margin-bottom: 10px;">
                    üèôÔ∏è D√©couper une ville
                </button>
            </div>

            <!-- D√©coupage intelligent de ville -->
            <div class="map-controls" id="cityDivisionPanel" style="display: none;">
                <h4>üèôÔ∏è D√©coupage Intelligent</h4>
                <div class="city-input-group">
                    <input type="text" id="cityNameInput" placeholder="Nom de la ville (ex: Dieppe)">
                    <input type="number" id="hoursPerZone" placeholder="Heures/zone" value="2" min="0.5" max="8" step="0.5">
                </div>
                <button class="btn btn-primary" onclick="divideCity()">
                    üîç Analyser et d√©couper
                </button>
            </div>

            <!-- Suggestions de zones -->
            <div id="zoneSuggestions"></div>

            <!-- Liste des zones cr√©√©es -->
            <div id="zonesList"></div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="fab" onclick="createRoute()">
        üó∫Ô∏è
    </button>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchScreen('search')">
            <span class="nav-icon">üîç</span>
            <span class="nav-label">Recherche</span>
        </button>
        <button class="nav-item" onclick="switchScreen('results')">
            <span class="nav-icon">üìã</span>
            <span class="nav-label">R√©sultats</span>
        </button>
        <button class="nav-item" onclick="switchScreen('route')">
            <span class="nav-icon">üöó</span>
            <span class="nav-label">Route</span>
        </button>
        <button class="nav-item" onclick="switchScreen('zones')">
            <span class="nav-icon">üó∫Ô∏è</span>
            <span class="nav-label">Zones</span>
        </button>
        <button class="nav-item" onclick="switchScreen('notes')" style="position: relative;">
            <span class="nav-icon">üìù</span>
            <span class="nav-label">Notes</span>
            <span class="nav-badge" id="notesBadge" style="display: none;">0</span>
        </button>
    </div>

    <script>
        let currentData = [];
        let filteredData = [];
        let currentAddresses = [];
        let dpeNotes = {};
        let activeStreetFilter = '';
        let activeCityFilter = '';
        let activeSurfaceFilter = 'all';
        let userLocation = null;
        let searchRadius = 1;
        let isGeoSearch = false;

        // Cache optimis√© pour les noms de communes
        const communeCache = new Map();

        // AM√âLIORATION: Fonction pour extraire le code INSEE de l'API ADEME
        function getInseeCode(dpe) {
            // V√©rifier d'abord si on a r√©cup√©r√© le code via BAN
            if (dpe._code_insee_recovered) {
                return String(dpe._code_insee_recovered);
            }
            
            // L'API ADEME DPE utilise ces champs (par ordre de priorit√©)
            const code = dpe.code_insee_commune_actualise || 
                   dpe.code_insee_commune ||
                   dpe.code_commune_insee || 
                   dpe.insee_commune || 
                   dpe.code_insee ||
                   dpe.numero_commune ||
                   dpe.commune_code ||
                   null;
            
            // Si on a un code, on v√©rifie qu'il fait bien 5 chiffres
            if (code && /^\d{5}$/.test(String(code))) {
                return String(code);
            }
            
            return null;
        }

        // AM√âLIORATION: R√©cup√©ration optimis√©e du nom de commune via code INSEE
        async function getCommuneFromInsee(codeInsee) {
            if (!codeInsee) return null;
            
            // V√©rifier le cache
            if (communeCache.has(codeInsee)) {
                return communeCache.get(codeInsee);
            }

            try {
                // Appel √† l'API geo.gouv.fr avec le code INSEE
                const response = await fetch(`https://geo.api.gouv.fr/communes/${codeInsee}?fields=nom&format=json`);
                
                if (response.ok) {
                    const commune = await response.json();
                    if (commune && commune.nom) {
                        communeCache.set(codeInsee, commune.nom);
                        console.log(`‚úÖ INSEE ${codeInsee} ‚Üí ${commune.nom}`);
                        return commune.nom;
                    }
                }
            } catch (error) {
                console.error(`‚ùå Erreur r√©cup√©ration commune ${codeInsee}:`, error);
            }
            
            return null;
        }

        // AM√âLIORATION: Fallback avec code postal si pas de code INSEE
        async function getCommuneFromCodePostal(codePostal) {
            if (!codePostal) return null;
            
            const cacheKey = `CP_${codePostal}`;
            if (communeCache.has(cacheKey)) {
                return communeCache.get(cacheKey);
            }

            try {
                const response = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${codePostal}&fields=nom&format=json&limit=1`);
                const communes = await response.json();
                
                if (communes && communes.length > 0) {
                    const communeName = communes[0].nom;
                    communeCache.set(cacheKey, communeName);
                    console.log(`‚úÖ CP ${codePostal} ‚Üí ${communeName} (‚ö†Ô∏è impr√©cis si multi-communes)`);
                    return communeName;
                }
            } catch (error) {
                console.error(`‚ùå Erreur r√©cup√©ration commune CP ${codePostal}:`, error);
            }
            
            return null;
        }

        // NOUVEAU: Essayer de r√©cup√©rer le code INSEE depuis l'adresse compl√®te
        async function getInseeFromAddress(adresse, codePostal) {
            if (!adresse || !codePostal) return null;
            
            try {
                // Utiliser l'API BAN (Base Adresse Nationale)
                const query = encodeURIComponent(`${adresse} ${codePostal}`);
                const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${query}&limit=1`);
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    const cityCode = feature.properties.citycode;
                    if (cityCode && /^\d{5}$/.test(cityCode)) {
                        console.log(`üéØ Code INSEE trouv√© via BAN pour "${adresse}": ${cityCode}`);
                        return cityCode;
                    }
                }
            } catch (error) {
                console.error('Erreur API BAN:', error);
            }
            
            return null;
        }

        // AM√âLIORATION: Enrichissement intelligent avec priorit√© au code INSEE
        async function enrichWithCommuneNames(dpeList) {
            console.log('üîç Enrichissement des DPE avec les noms de communes...');
            
            // DEBUG: Afficher un exemple de DPE pour voir les champs disponibles
            if (dpeList.length > 0) {
                console.log('üìã Exemple de DPE brut:', dpeList[0]);
                console.log('üìã Tous les champs du DPE:', Object.keys(dpeList[0]));
                const testCodeInsee = getInseeCode(dpeList[0]);
                console.log(`üìã Code INSEE extrait du premier DPE: ${testCodeInsee || 'AUCUN ‚ùå'}`);
            }
            
            // Collecter tous les codes uniques (INSEE prioritaire)
            const uniqueCodes = new Map();
            let countWithInsee = 0;
            let countWithoutInsee = 0;
            
            dpeList.forEach(dpe => {
                const codeInsee = getInseeCode(dpe);
                const codePostal = dpe.code_postal_brut;
                
                // Priorit√© au code INSEE
                if (codeInsee) {
                    countWithInsee++;
                    if (!uniqueCodes.has(codeInsee)) {
                        uniqueCodes.set(codeInsee, { type: 'insee', code: codeInsee });
                    }
                }
                // Sinon fallback sur code postal (mais on garde trace de chaque DPE)
                else if (codePostal) {
                    countWithoutInsee++;
                    // Pour les codes postaux, on ne peut pas distinguer les communes
                    // donc on marque juste qu'on a besoin de ce code postal
                    if (!uniqueCodes.has(`CP_${codePostal}`)) {
                        uniqueCodes.set(`CP_${codePostal}`, { type: 'postal', code: codePostal });
                    }
                }
            });
            
            console.log(`üìä ${countWithInsee} DPE avec code INSEE ‚úÖ`);
            console.log(`üìä ${countWithoutInsee} DPE SANS code INSEE ‚ö†Ô∏è`);
            console.log(`üìä ${uniqueCodes.size} codes uniques √† traiter`);
            
            // Pour les DPE sans code INSEE, essayer de le r√©cup√©rer via l'API BAN
            if (countWithoutInsee > 0 && countWithoutInsee <= 50) { // Limiter √† 50 requ√™tes BAN
                console.log(`üîß Tentative de r√©cup√©ration des codes INSEE via API BAN...`);
                let recovered = 0;
                
                for (let i = 0; i < dpeList.length && recovered < 50; i++) {
                    const dpe = dpeList[i];
                    if (!getInseeCode(dpe) && dpe.adresse_brut && dpe.code_postal_brut) {
                        const codeInsee = await getInseeFromAddress(dpe.adresse_brut, dpe.code_postal_brut);
                        if (codeInsee) {
                            // Ajouter au DPE
                            dpe._code_insee_recovered = codeInsee;
                            // Ajouter √† la liste des codes √† traiter
                            if (!uniqueCodes.has(codeInsee)) {
                                uniqueCodes.set(codeInsee, { type: 'insee', code: codeInsee });
                                await getCommuneFromInsee(codeInsee);
                            }
                            recovered++;
                        }
                        // Petite pause pour ne pas surcharger l'API
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                console.log(`‚úÖ ${recovered} codes INSEE r√©cup√©r√©s via API BAN`);
            } else if (countWithoutInsee > 50) {
                console.warn(`‚ö†Ô∏è ATTENTION: ${countWithoutInsee} DPE n'ont pas de code INSEE !`);
                console.warn(`‚ö†Ô∏è C'est trop pour utiliser l'API BAN. Fallback sur code postal.`);
                console.warn(`‚ö†Ô∏è Le code postal 76260 correspond √† plusieurs communes (Baromesnil, Ponts-et-Marais, etc.)`);
                console.warn(`‚ö†Ô∏è Sans code INSEE, on ne peut pas d√©terminer la vraie commune.`);
            }
            
            // R√©cup√©rer tous les noms en parall√®le
            const promises = Array.from(uniqueCodes.values()).map(({type, code}) => {
                if (type === 'insee') {
                    return getCommuneFromInsee(code);
                } else {
                    return getCommuneFromCodePostal(code);
                }
            });
            
            await Promise.all(promises);
            
            // Ajouter les noms aux DPE
            return dpeList.map(dpe => {
                const codeInsee = getInseeCode(dpe);
                const codePostal = dpe.code_postal_brut;
                
                let communeName = null;
                let needsWarning = false;
                
                // Priorit√© 1: Code INSEE
                if (codeInsee && communeCache.has(codeInsee)) {
                    communeName = communeCache.get(codeInsee);
                }
                // Priorit√© 2: Code Postal (mais on pr√©vient que c'est impr√©cis)
                else if (codePostal && communeCache.has(`CP_${codePostal}`)) {
                    communeName = communeCache.get(`CP_${codePostal}`);
                    needsWarning = true; // On marque qu'il manque le code INSEE
                }
                
                return {
                    ...dpe,
                    commune: communeName,
                    commune_needs_warning: needsWarning,
                    code_insee: codeInsee // On garde le code INSEE pour l'affichage
                };
            });
        }

        function loadNotes() {
            const saved = localStorage.getItem('dpeNotes');
            if (saved) {
                dpeNotes = JSON.parse(saved);
            }
        }

        function saveNotes() {
            localStorage.setItem('dpeNotes', JSON.stringify(dpeNotes));
            updateNotesBadge();
        }

        function updateNotesBadge() {
            const notesCount = Object.entries(dpeNotes).filter(([key, note]) => 
                note.status || note.comment
            ).length;
            
            const badge = document.getElementById('notesBadge');
            if (badge) {
                if (notesCount > 0) {
                    badge.textContent = notesCount > 99 ? '99+' : notesCount;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function toggleGeoSearch() {
            const geoOptions = document.getElementById('geoOptions');
            geoOptions.classList.toggle('active');
        }

        function selectRadius(radius) {
            searchRadius = radius;
            document.querySelectorAll('.radius-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        async function searchByGeolocation() {
            if (!navigator.geolocation) {
                alert('La g√©olocalisation n\'est pas support√©e par votre navigateur');
                return;
            }

            const geoInfo = document.getElementById('geoInfo');
            geoInfo.style.display = 'block';
            geoInfo.textContent = 'üìç Localisation en cours...';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    
                    geoInfo.textContent = `‚úÖ Position d√©tect√©e ! (${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)})`;
                    
                    try {
                        const postalCodes = await getPostalCodesInRadius(userLocation.lat, userLocation.lon, searchRadius);
                        
                        if (postalCodes.length === 0) {
                            geoInfo.textContent = '‚ùå Aucun code postal trouv√© dans ce rayon. Essayez un rayon plus grand.';
                            return;
                        }

                        document.getElementById('codePostal').value = postalCodes.join(', ');
                        isGeoSearch = true;
                        
                        geoInfo.textContent = `üîç ${postalCodes.length} code(s) postal(aux) trouv√©(s): ${postalCodes.join(', ')}. Recherche des DPE...`;
                        
                        await searchDPE();
                    } catch (error) {
                        geoInfo.textContent = '‚ùå Erreur lors de la r√©cup√©ration des codes postaux';
                        console.error(error);
                    }
                },
                (error) => {
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '‚ùå Vous devez autoriser la g√©olocalisation dans les param√®tres de votre navigateur';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = '‚ùå Position indisponible';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '‚ùå D√©lai d√©pass√©';
                            break;
                        default:
                            errorMsg = '‚ùå Erreur inconnue';
                    }
                    geoInfo.textContent = errorMsg;
                }
            );
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function getPostalCodesInRadius(lat, lon, radius) {
            try {
                const response = await fetch(`https://geo.api.gouv.fr/communes?lat=${lat}&lon=${lon}&fields=codesPostaux&format=json&geometry=centre`);
                const communes = await response.json();
                
                const postalCodes = new Set();
                communes.forEach(commune => {
                    if (commune.codesPostaux) {
                        commune.codesPostaux.forEach(cp => postalCodes.add(cp));
                    }
                });
                
                if (radius > 1) {
                    const nearbyResponse = await fetch(`https://geo.api.gouv.fr/communes?lat=${lat}&lon=${lon}&fields=codesPostaux&format=json`);
                    const nearbyCom = await nearbyResponse.json();
                    nearbyCom.slice(0, Math.ceil(radius * 2)).forEach(commune => {
                        if (commune.codesPostaux) {
                            commune.codesPostaux.forEach(cp => postalCodes.add(cp));
                        }
                    });
                }
                
                return Array.from(postalCodes);
            } catch (error) {
                console.error('Erreur API geo.api.gouv.fr:', error);
                return [];
            }
        }

        function switchScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            if (screen === 'search') {
                document.getElementById('searchScreen').classList.add('active');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else if (screen === 'results') {
                document.getElementById('resultsScreen').classList.add('active');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            } else if (screen === 'route') {
                document.getElementById('routeScreen').classList.add('active');
                document.querySelectorAll('.nav-item')[2].classList.add('active');
            } else if (screen === 'zones') {
                document.getElementById('zonesScreen').classList.add('active');
                document.querySelectorAll('.nav-item')[3].classList.add('active');
                initMap();
            } else if (screen === 'notes') {
                document.getElementById('notesScreen').classList.add('active');
                document.querySelectorAll('.nav-item')[4].classList.add('active');
                displayAllNotes();
            }
        }

        async function searchDPE() {
            const codePostalInput = document.getElementById('codePostal').value.trim();
            const annee = document.getElementById('annee').value;
            const mois = document.getElementById('mois').value;
            const classeFilter = document.getElementById('classeFilter').value;

            if (!codePostalInput) {
                alert('Veuillez entrer au moins un code postal');
                return;
            }

            const codesPostaux = codePostalInput
                .split(/[,;\s]+/)
                .map(cp => cp.trim())
                .filter(cp => cp.length > 0);

            if (codesPostaux.length === 0) {
                alert('Veuillez entrer au moins un code postal valide');
                return;
            }

            document.getElementById('loading').style.display = 'block';

            // Utilisation de l'API DPE03 (plus r√©cente)
            const url = 'https://data.ademe.fr/data-fair/api/v1/datasets/dpe03existant/lines';

            let dateDebut, dateFin;

            if (mois) {
                const lastDay = new Date(annee, parseInt(mois), 0).getDate();
                dateDebut = `${annee}-${mois}-01`;
                dateFin = `${annee}-${mois}-${lastDay}`;
            } else {
                dateDebut = annee === '2021' ? '2021-07-01' : `${annee}-01-01`;
                dateFin = `${annee}-12-31`;
            }

            const postalCodesQuery = codesPostaux.map(cp => `code_postal_brut:${cp}`).join(' OR ');
            let qs = `(${postalCodesQuery}) AND date_etablissement_dpe:[${dateDebut} TO ${dateFin}]`;
            
            if (classeFilter) {
                const classes = classeFilter.split(',');
                const classFilter = classes.map(c => `classe_consommation_energie:${c}`).join(' OR ');
                qs += ` AND (${classFilter})`;
            }

            const params = new URLSearchParams({
                size: 1000,
                qs: qs
            });

            try {
                const response = await fetch(`${url}?${params}`);
                const data = await response.json();
                currentData = data.results || [];

                console.log(`üìä ${currentData.length} DPE trouv√©s`);
                
                // Debug: afficher un exemple
                if (currentData.length > 0) {
                    console.log('üîç DEBUG - Exemple de DPE:', currentData[0]);
                    const codeInsee = getInseeCode(currentData[0]);
                    console.log(`üîç DEBUG - Code INSEE extrait: ${codeInsee}`);
                }

                // AM√âLIORATION: Enrichir avec les noms de communes via l'API
                showToast('R√©cup√©ration des noms de communes...');
                currentData = await enrichWithCommuneNames(currentData);

                if (isGeoSearch && userLocation) {
                    currentData = await enrichWithDistances(currentData);
                    currentData = currentData.filter(dpe => dpe.distance <= searchRadius);
                    currentData.sort((a, b) => (a.distance || 999) - (b.distance || 999));
                } else {
                    currentData.sort((a, b) => {
                        const dateA = new Date(a.date_etablissement_dpe || '1900-01-01');
                        const dateB = new Date(b.date_etablissement_dpe || '1900-01-01');
                        return dateB - dateA;
                    });
                }

                filteredData = [...currentData];

                displayResults(data, codesPostaux, annee, mois);
                switchScreen('results');

            } catch (error) {
                alert('Erreur lors de la recherche');
                console.error(error);
            } finally {
                document.getElementById('loading').style.display = 'none';
                isGeoSearch = false;
            }
        }

        async function enrichWithDistances(dpeList) {
            return dpeList.map(dpe => {
                const simulatedDistance = Math.random() * searchRadius * 1.2;
                return {
                    ...dpe,
                    distance: parseFloat(simulatedDistance.toFixed(2))
                };
            });
        }

        function displayResults(data, codesPostaux, annee, mois) {
            const total = data.total || 0;
            const results = currentData;

            const moisNoms = {
                '01': 'Janvier', '02': 'F√©vrier', '03': 'Mars', '04': 'Avril',
                '05': 'Mai', '06': 'Juin', '07': 'Juillet', '08': 'Ao√ªt',
                '09': 'Septembre', '10': 'Octobre', '11': 'Novembre', '12': 'D√©cembre'
            };

            const header = document.getElementById('resultsHeader');

            if (results.length === 0) {
                const periode = mois ? `${moisNoms[mois]} ${annee}` : annee;
                const cpText = codesPostaux.length > 1 ? codesPostaux.join(', ') : codesPostaux[0];
                header.innerHTML = `
                    <h3>Aucun r√©sultat</h3>
                    <p>Aucun DPE trouv√© pour ${cpText} en ${periode}</p>
                `;
                document.getElementById('resultsList').innerHTML = '';
                document.getElementById('fab').classList.remove('show');
                document.getElementById('cityFilterSection').style.display = 'none';
                document.getElementById('surfaceFilterSection').style.display = 'none';
                document.getElementById('filterSection').style.display = 'none';
                return;
            }

            const classeCount = {};
            results.forEach(dpe => {
                const classe = dpe.classe_consommation_energie || 'N/A';
                classeCount[classe] = (classeCount[classe] || 0) + 1;
            });

            const periode = mois ? `${moisNoms[mois]} ${annee}` : annee;
            const cpText = codesPostaux.length > 1 
                ? `${codesPostaux.length} codes postaux` 
                : codesPostaux[0];
            
            const geoInfo = isGeoSearch 
                ? `<p style="color: #00c9ff; font-size: 0.9em;">üìç Recherche g√©olocalis√©e dans un rayon de ${searchRadius} km</p>`
                : '';
            
            // V√©rifier si certains DPE manquent de code INSEE
            const missingInsee = results.filter(dpe => !dpe.code_insee).length;
            const inseeWarning = missingInsee > 0 
                ? `<p style="color: #ff9800; font-size: 0.85em; margin-top: 5px;">‚ö†Ô∏è ${missingInsee} DPE sans code INSEE - commune approximative via code postal</p>`
                : '';

            header.innerHTML = `
                <h3>${results.length} DPE trouv√©${results.length > 1 ? 's' : ''}</h3>
                <p>${cpText} - ${periode}</p>
                ${geoInfo}
                ${inseeWarning}
                <div class="stats">
                    ${Object.entries(classeCount).map(([classe, count]) => `
                        <span class="stat-badge classe-${classe === 'N/A' ? 'NA' : classe}">${classe}: ${count}</span>
                    `).join('')}
                </div>
                <div class="action-buttons">
                    <button class="btn btn-small btn-success" onclick="exportCSV()">
                        üì• Export CSV
                    </button>
                    <button class="btn btn-small btn-warning" onclick="sendAllToModelo()">
                        üìã Copier pour Modelo
                    </button>
                </div>
            `;
            
            // Cr√©er les filtres de communes
            const cities = {};
            results.forEach(dpe => {
                const city = dpe.commune || (dpe.code_postal_brut ? `CP ${dpe.code_postal_brut}` : 'Commune inconnue');
                cities[city] = (cities[city] || 0) + 1;
            });

            if (Object.keys(cities).length > 1) {
                const cityFilterSection = document.getElementById('cityFilterSection');
                cityFilterSection.style.display = 'block';
                const cityFilters = document.getElementById('cityFilters');
                cityFilters.innerHTML = `
                    <button class="filter-btn ${activeCityFilter === '' ? 'active' : ''}" onclick="filterByCity('')">
                        Toutes (${results.length})
                    </button>
                    ${Object.entries(cities).sort().map(([city, count]) => `
                        <button class="filter-btn ${activeCityFilter === city ? 'active' : ''}" onclick="filterByCity('${city.replace(/'/g, "\\'")}')">
                            ${city} (${count})
                        </button>
                    `).join('')}
                `;
            } else {
                document.getElementById('cityFilterSection').style.display = 'none';
            }

            document.getElementById('surfaceFilterSection').style.display = 'block';

            const streets = {};
            results.forEach(dpe => {
                const addr = dpe.adresse_brut || '';
                const streetMatch = addr.match(/(?:rue|avenue|boulevard|place|chemin|all√©e|impasse)\s+([^,]+)/i);
                const street = streetMatch ? streetMatch[0] : 'Autre';
                streets[street] = (streets[street] || 0) + 1;
            });

            if (Object.keys(streets).length > 1) {
                const filterSection = document.getElementById('filterSection');
                filterSection.style.display = 'block';
                const streetSelect = document.getElementById('streetSelect');
                
                streetSelect.innerHTML = `<option value="">Toutes les rues (${results.length})</option>`;
                
                Object.entries(streets).sort().forEach(([street, count]) => {
                    const option = document.createElement('option');
                    option.value = street;
                    option.textContent = `${street} (${count})`;
                    if (activeStreetFilter === street) {
                        option.selected = true;
                    }
                    streetSelect.appendChild(option);
                });
            } else {
                document.getElementById('filterSection').style.display = 'none';
            }

            activeCityFilter = '';
            activeStreetFilter = '';
            activeSurfaceFilter = 'all';

            applyFilters();

            document.getElementById('fab').classList.add('show');

            currentAddresses = results.map(dpe => {
                let addr = dpe.adresse_brut || '';
                if (dpe.code_postal_brut) addr += ', ' + dpe.code_postal_brut;
                if (dpe.commune) addr += ' ' + dpe.commune;
                return addr;
            }).filter(a => a);
        }

        function filterByCity(city) {
            activeCityFilter = city;
            applyFilters();
            
            document.querySelectorAll('#cityFilters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(city) || (city === '' && btn.textContent.includes('Toutes'))) {
                    btn.classList.add('active');
                }
            });
        }

        function filterByStreet(street) {
            activeStreetFilter = street;
            applyFilters();
        }

        function filterBySurface(range) {
            activeSurfaceFilter = range;
            applyFilters();
            
            document.querySelectorAll('.surface-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function applyFilters() {
            let filtered = [...currentData];

            if (activeCityFilter) {
                filtered = filtered.filter(dpe => {
                    const city = dpe.commune || (dpe.code_postal_brut ? `CP ${dpe.code_postal_brut}` : 'Commune inconnue');
                    return city === activeCityFilter;
                });
            }

            if (activeStreetFilter) {
                filtered = filtered.filter(dpe => {
                    const addr = dpe.adresse_brut || '';
                    return addr.toLowerCase().includes(activeStreetFilter.toLowerCase());
                });
            }

            if (activeSurfaceFilter !== 'all') {
                const [min, max] = activeSurfaceFilter.split('-').map(Number);
                filtered = filtered.filter(dpe => {
                    const surface = parseFloat(dpe.surface_habitable_logement) || 0;
                    return surface >= min && surface <= max;
                });
            }

            filteredData = filtered;
            displayFilteredResults(filtered);
        }

        function displayFilteredResults(results) {
            const list = document.getElementById('resultsList');
            
            if (results.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <h3>Aucun r√©sultat</h3>
                        <p>Aucun DPE ne correspond aux filtres s√©lectionn√©s</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = results.map((dpe, index) => {
                const noteKey = `${dpe.adresse_brut}_${dpe.date_etablissement_dpe}`;
                const note = dpeNotes[noteKey] || {};
                const hasNote = note.status || note.comment;
                
                // AM√âLIORATION: Affichage du nom de commune + code INSEE
                const ville = dpe.commune || (dpe.code_postal_brut ? `CP ${dpe.code_postal_brut}` : 'Commune inconnue');
                const isCodePostalFallback = dpe.commune_needs_warning === true;
                const warningIcon = isCodePostalFallback ? ' ‚ö†Ô∏è' : '';
                
                const codeInseeDisplay = dpe.code_insee 
                    ? `<div class="dpe-insee">INSEE: ${dpe.code_insee} ‚úÖ</div>` 
                    : `<div class="dpe-insee" style="color: #ff9800;">Pas de code INSEE${warningIcon}</div>`;
                
                const distanceInfo = dpe.distance 
                    ? `<div class="dpe-distance">üìè ${dpe.distance} km</div>` 
                    : '';
                
                return `
                    <div class="dpe-card ${hasNote ? 'has-note' : ''}" id="dpe-${index}">
                        <div class="dpe-header">
                            <div>
                                <div class="dpe-address">üìç ${dpe.adresse_brut || 'Adresse non renseign√©e'}</div>
                                <div class="dpe-city">üèôÔ∏è ${ville}${warningIcon}</div>
                                ${codeInseeDisplay}
                                ${distanceInfo}
                            </div>
                            <span class="classe-badge classe-${dpe.classe_consommation_energie || 'NA'}">
                                ${dpe.classe_consommation_energie || 'N/A'}
                            </span>
                        </div>
                        <div class="dpe-info">
                            <div class="info-item">üìÖ <strong>${dpe.date_etablissement_dpe || 'N/A'}</strong></div>
                            <div class="info-item">üìê <strong>${dpe.surface_habitable_logement || 'N/A'} m¬≤</strong></div>
                            <div class="info-item">üå°Ô∏è GES: <strong>${dpe.classe_estimation_ges || 'N/A'}</strong></div>
                            <div class="info-item">üèóÔ∏è <strong>${dpe.type_batiment || 'N/A'}</strong></div>
                        </div>
                        <div class="dpe-actions">
                            <div class="status-buttons">
                                <button class="status-btn ${note.status === 'to-visit' ? 'active' : ''}" 
                                        onclick="setStatus('${noteKey}', 'to-visit', ${index})">
                                    üìç √Ä visiter
                                </button>
                                <button class="status-btn visited ${note.status === 'visited' ? 'active' : ''}" 
                                        onclick="setStatus('${noteKey}', 'visited', ${index})">
                                    ‚úÖ Visit√©
                                </button>
                                <button class="status-btn interested ${note.status === 'interested' ? 'active' : ''}" 
                                        onclick="setStatus('${noteKey}', 'interested', ${index})">
                                    ‚≠ê Int√©ress√©
                                </button>
                                <button class="status-btn not-interested ${note.status === 'not-interested' ? 'active' : ''}" 
                                        onclick="setStatus('${noteKey}', 'not-interested', ${index})">
                                    ‚ùå Pas int√©ress√©
                                </button>
                            </div>
                            <div class="note-section">
                                <textarea class="note-input" 
                                          placeholder="Ajouter une note..." 
                                          onblur="saveNote('${noteKey}', this.value, ${index})"
                                          >${note.comment || ''}</textarea>
                            </div>
                            <button class="modelo-btn" onclick="sendToModelo(${index})">
                                üìã Copier pour Modelo
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setStatus(noteKey, status, index) {
            if (!dpeNotes[noteKey]) {
                dpeNotes[noteKey] = {};
            }
            
            if (dpeNotes[noteKey].status === status) {
                delete dpeNotes[noteKey].status;
            } else {
                dpeNotes[noteKey].status = status;
            }
            
            saveNotes();
            
            const card = document.getElementById(`dpe-${index}`);
            if (card) {
                const buttons = card.querySelectorAll('.status-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.includes('√Ä visiter') && status === 'to-visit' && dpeNotes[noteKey].status) {
                        btn.classList.add('active');
                    } else if (btn.textContent.includes('Visit√©') && status === 'visited' && dpeNotes[noteKey].status) {
                        btn.classList.add('active');
                    } else if (btn.textContent.includes('Int√©ress√©') && status === 'interested' && dpeNotes[noteKey].status) {
                        btn.classList.add('active');
                    } else if (btn.textContent.includes('Pas int√©ress√©') && status === 'not-interested' && dpeNotes[noteKey].status) {
                        btn.classList.add('active');
                    }
                });
                
                if (dpeNotes[noteKey].status || dpeNotes[noteKey].comment) {
                    card.classList.add('has-note');
                } else {
                    card.classList.remove('has-note');
                }
            }
            
            showToast('Statut mis √† jour');
        }

        function saveNote(noteKey, comment, index) {
            if (!dpeNotes[noteKey]) {
                dpeNotes[noteKey] = {};
            }
            
            if (comment.trim()) {
                dpeNotes[noteKey].comment = comment;
            } else {
                delete dpeNotes[noteKey].comment;
            }
            
            saveNotes();
            
            const card = document.getElementById(`dpe-${index}`);
            if (card) {
                if (dpeNotes[noteKey].status || dpeNotes[noteKey].comment) {
                    card.classList.add('has-note');
                } else {
                    card.classList.remove('has-note');
                }
            }
            
            if (comment.trim()) {
                showToast('Note sauvegard√©e');
            }
        }

        function sendToModelo(index) {
            const dpe = filteredData[index];
            const address = dpe.adresse_brut || '';
            const postalCode = dpe.code_postal_brut || '';
            const city = dpe.commune || '';
            const insee = dpe.code_insee || '';
            
            const fullAddress = `${address}, ${postalCode} ${city}`;
            
            const distanceText = dpe.distance ? `\nüìè Distance: ${dpe.distance} km` : '';
            const inseeText = insee ? `\nüèõÔ∏è INSEE: ${insee}` : '';
            const message = `üè† Nouvelle prospection DPE\n\nüìç Adresse: ${fullAddress}\nüèôÔ∏è Commune: ${city}${inseeText}${distanceText}\n‚ö° Classe: ${dpe.classe_consommation_energie || 'N/A'}\nüìê Surface: ${dpe.surface_habitable_logement || 'N/A'} m¬≤\nüìÖ Date DPE: ${dpe.date_etablissement_dpe || 'N/A'}\nüèóÔ∏è Type: ${dpe.type_batiment || 'N/A'}`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(message).then(() => {
                    showToast('üìã Adresse copi√©e ! Collez dans Modelo');
                }).catch(() => {
                    copyFallback(message);
                });
            } else {
                copyFallback(message);
            }
        }
        
        function copyFallback(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('üìã Adresse copi√©e ! Collez dans Modelo');
            } catch (err) {
                showToast('‚ö†Ô∏è Copie manuelle requise');
                alert(`Copiez cette adresse pour Modelo:\n\n${text}`);
            }
            document.body.removeChild(textArea);
        }

        function sendAllToModelo() {
            if (filteredData.length === 0) {
                alert('Aucune adresse √† envoyer');
                return;
            }
            
            let allAddresses = 'üìã LISTE DPE POUR MODELO\n';
            allAddresses += '='.repeat(30) + '\n\n';
            
            filteredData.forEach((dpe, index) => {
                const address = dpe.adresse_brut || '';
                const postalCode = dpe.code_postal_brut || '';
                const city = dpe.commune || '';
                const insee = dpe.code_insee || '';
                const fullAddress = `${address}, ${postalCode} ${city}`;
                
                allAddresses += `${index + 1}. ${fullAddress}\n`;
                if (insee) allAddresses += `   INSEE: ${insee} | `;
                if (dpe.distance) allAddresses += `Distance: ${dpe.distance} km | `;
                allAddresses += `Commune: ${city} | `;
                allAddresses += `Classe: ${dpe.classe_consommation_energie || 'N/A'} | `;
                allAddresses += `Surface: ${dpe.surface_habitable_logement || 'N/A'}m¬≤ | `;
                allAddresses += `Type: ${dpe.type_batiment || 'N/A'}\n\n`;
            });
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(allAddresses).then(() => {
                    showToast(`üìã ${filteredData.length} adresses copi√©es !`);
                    alert(`‚úÖ ${filteredData.length} adresses copi√©es !\n\nCollez-les dans Modelo pour les importer en masse.`);
                }).catch(() => {
                    copyFallback(allAddresses);
                });
            } else {
                copyFallback(allAddresses);
            }
        }

        function exportCSV() {
            if (filteredData.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }
            
            let csv = 'Adresse,Code Postal,Commune,Code INSEE,Distance (km),Classe √ânergie,Classe GES,Surface,Date DPE,Type B√¢timent,Statut,Note\n';
            
            filteredData.forEach(dpe => {
                const noteKey = `${dpe.adresse_brut}_${dpe.date_etablissement_dpe}`;
                const note = dpeNotes[noteKey] || {};
                
                const row = [
                    dpe.adresse_brut || '',
                    dpe.code_postal_brut || '',
                    dpe.commune || '',
                    dpe.code_insee || '',
                    dpe.distance || '',
                    dpe.classe_consommation_energie || '',
                    dpe.classe_estimation_ges || '',
                    dpe.surface_habitable_logement || '',
                    dpe.date_etablissement_dpe || '',
                    dpe.type_batiment || '',
                    note.status || '',
                    note.comment || ''
                ];
                
                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `DPE_Export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Export CSV r√©ussi');
        }

        function createRoute() {
            if (currentAddresses.length === 0) {
                alert('Recherchez d\'abord des DPE');
                return;
            }

            document.getElementById('emptyRoute').style.display = 'none';
            document.getElementById('routeContent').style.display = 'block';

            document.getElementById('routeTotal').textContent = currentAddresses.length;

            const numRoutes = Math.ceil(currentAddresses.length / 9);
            document.getElementById('routeInfo').textContent = 
                numRoutes > 1 ? `Divis√© en ${numRoutes} itin√©raires optimis√©s` : 'Un seul itin√©raire optimis√©';

            if (currentAddresses.length > 10) {
                document.getElementById('routeAlert').style.display = 'block';
            }

            const notedCount = currentData.filter(dpe => {
                const noteKey = `${dpe.adresse_brut}_${dpe.date_etablissement_dpe}`;
                return dpeNotes[noteKey] && dpeNotes[noteKey].status;
            }).length;
            
            const progress = (notedCount / currentAddresses.length) * 100;
            document.getElementById('routeProgress').style.width = `${progress}%`;

            const linksDiv = document.getElementById('routeLinks');
            linksDiv.innerHTML = '';

            for (let i = 0; i < numRoutes; i++) {
                const start = i * 9;
                const end = Math.min(start + 9, currentAddresses.length);
                const routeAddresses = currentAddresses.slice(start, end);

                const origin = encodeURIComponent(routeAddresses[0]);
                const destination = encodeURIComponent(routeAddresses[routeAddresses.length - 1]);
                const waypoints = routeAddresses.slice(1, -1).map(a => encodeURIComponent(a)).join('|');

                let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
                if (waypoints) url += `&waypoints=${waypoints}`;
                url += '&travelmode=driving&waypoint_optimization=true';

                linksDiv.innerHTML += `
                    <div class="route-card">
                        <h4>üöó Itin√©raire ${i + 1}/${numRoutes} <span class="address-count">${start + 1}-${end}</span></h4>
                        <button class="btn btn-success" onclick="window.open('${url}', '_blank')">
                            Ouvrir l'itin√©raire ${i + 1}
                        </button>
                    </div>
                `;
            }

            switchScreen('route');
        }

        function openAllRoutes() {
            const numRoutes = Math.ceil(currentAddresses.length / 9);
            for (let i = 0; i < Math.min(numRoutes, 3); i++) {
                setTimeout(() => {
                    const start = i * 9;
                    const end = Math.min(start + 9, currentAddresses.length);
                    const routeAddresses = currentAddresses.slice(start, end);

                    const origin = encodeURIComponent(routeAddresses[0]);
                    const destination = encodeURIComponent(routeAddresses[routeAddresses.length - 1]);
                    const waypoints = routeAddresses.slice(1, -1).map(a => encodeURIComponent(a)).join('|');

                    let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
                    if (waypoints) url += `&waypoints=${waypoints}`;
                    url += '&travelmode=driving&waypoint_optimization=true';

                    window.open(url, '_blank');
                }, i * 500);
            }
            
            showToast('Ouverture des itin√©raires...');
        }

        loadNotes();
        updateNotesBadge();

        document.getElementById('codePostal').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchDPE();
        });

        let notesFilter = '';
        let notesSearchTerm = '';

        function displayAllNotes() {
            const allNotes = Object.entries(dpeNotes);
            const notesWithContent = allNotes.filter(([key, note]) => 
                note.status || note.comment
            );
            
            document.getElementById('notesCount').textContent = 
                `${notesWithContent.length} adresse(s) avec des notes`;
            
            if (notesWithContent.length === 0) {
                document.getElementById('notesList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <h3>Aucune note</h3>
                        <p>Vos notes appara√Ætront ici</p>
                    </div>
                `;
                return;
            }
            
            const groupedNotes = {};
            notesWithContent.forEach(([key, note]) => {
                const parts = key.split('_');
                const dateStr = parts[parts.length - 1];
                const address = parts.slice(0, -1).join('_');
                
                const dateGroup = dateStr ? dateStr.substring(0, 7) : 'Sans date';
                
                if (!groupedNotes[dateGroup]) {
                    groupedNotes[dateGroup] = [];
                }
                
                groupedNotes[dateGroup].push({
                    address: address,
                    date: dateStr,
                    note: note,
                    key: key
                });
            });
            
            const sortedGroups = Object.keys(groupedNotes).sort().reverse();
            
            let html = '';
            sortedGroups.forEach(group => {
                const items = groupedNotes[group];
                
                let filteredItems = items;
                if (notesFilter) {
                    filteredItems = items.filter(item => item.note.status === notesFilter);
                }
                
                if (notesSearchTerm) {
                    filteredItems = filteredItems.filter(item => 
                        item.address.toLowerCase().includes(notesSearchTerm.toLowerCase()) ||
                        (item.note.comment && item.note.comment.toLowerCase().includes(notesSearchTerm.toLowerCase()))
                    );
                }
                
                if (filteredItems.length === 0) return;
                
                html += `
                    <div style="margin-top: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üìÖ ${group}</h4>
                `;
                
                filteredItems.forEach(item => {
                    const statusBadge = item.note.status ? getStatusBadge(item.note.status) : '';
                    
                    html += `
                        <div class="dpe-card has-note" style="margin-bottom: 10px;">
                            <div class="dpe-header">
                                <div class="dpe-address">üìç ${item.address || 'Adresse inconnue'}</div>
                                ${statusBadge}
                            </div>
                            ${item.note.comment ? `
                                <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                                    <strong>Note :</strong> ${item.note.comment}
                                </div>
                            ` : ''}
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <button class="btn btn-small btn-primary" onclick="editNote('${item.key}')">
                                    ‚úèÔ∏è Modifier
                                </button>
                                <button class="btn btn-small" style="background: #e31e24; color: white;" 
                                        onclick="deleteNote('${item.key}')">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            document.getElementById('notesList').innerHTML = html;
        }

        function getStatusBadge(status) {
            const badges = {
                'to-visit': '<span class="classe-badge" style="background: #667eea;">üìç √Ä visiter</span>',
                'visited': '<span class="classe-badge" style="background: #38ef7d;">‚úÖ Visit√©</span>',
                'interested': '<span class="classe-badge" style="background: #fdb913; color: black;">‚≠ê Int√©ress√©</span>',
                'not-interested': '<span class="classe-badge" style="background: #e31e24;">‚ùå Pas int√©ress√©</span>'
            };
            return badges[status] || '';
        }

        function filterNotes(status) {
            notesFilter = status;
            
            document.querySelectorAll('#notesScreen .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayAllNotes();
        }

        function searchNotes(term) {
            notesSearchTerm = term;
            displayAllNotes();
        }

        function editNote(key) {
            const note = dpeNotes[key];
            const newComment = prompt('Modifier la note :', note.comment || '');
            
            if (newComment !== null) {
                if (!dpeNotes[key]) {
                    dpeNotes[key] = {};
                }
                dpeNotes[key].comment = newComment;
                saveNotes();
                displayAllNotes();
                showToast('Note modifi√©e');
            }
        }

        function deleteNote(key) {
            if (confirm('Supprimer cette note ?')) {
                delete dpeNotes[key];
                saveNotes();
                displayAllNotes();
                showToast('Note supprim√©e');
            }
        }

        function clearAllNotes() {
            if (confirm('‚ö†Ô∏è Effacer TOUTES les notes ?\n\nCette action est irr√©versible !')) {
                dpeNotes = {};
                saveNotes();
                displayAllNotes();
                showToast('Toutes les notes supprim√©es');
            }
        }

        function exportAllNotes() {
            const allNotes = Object.entries(dpeNotes);
            const notesWithContent = allNotes.filter(([key, note]) => 
                note.status || note.comment
            );
            
            if (notesWithContent.length === 0) {
                alert('Aucune note √† exporter');
                return;
            }
            
            let csv = 'Adresse,Date DPE,Statut,Note,Date Export\n';
            
            notesWithContent.forEach(([key, note]) => {
                const parts = key.split('_');
                const dateStr = parts[parts.length - 1];
                const address = parts.slice(0, -1).join('_');
                
                const statusText = {
                    'to-visit': '√Ä visiter',
                    'visited': 'Visit√©',
                    'interested': 'Int√©ress√©',
                    'not-interested': 'Pas int√©ress√©'
                }[note.status] || '';
                
                const row = [
                    address || 'Adresse inconnue',
                    dateStr || '',
                    statusText,
                    note.comment || '',
                    new Date().toLocaleString('fr-FR')
                ];
                
                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Mes_Notes_DPE_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast(`Export de ${notesWithContent.length} notes r√©ussi`);
        }

        // ==================== ZONES SMART ====================
        let map = null;
        let mapInitialized = false;
        let drawControl = null;
        let drawnItems = null;
        let currentZone = null;
        let savedZones = [];

        function initMap() {
            if (mapInitialized && map) {
                map.invalidateSize();
                return;
            }

            // Initialiser la carte centr√©e sur la France
            map = L.map('map').setView([48.8566, 2.3522], 13);

            // Ajouter le fond de carte OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Initialiser les couches pour les dessins
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // G√©olocalisation automatique au chargement
            if (navigator.geolocation) {
                showToast('üìç G√©olocalisation en cours...');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        map.setView([lat, lon], 15);

                        // Ajouter un marqueur de position
                        L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: 'üìç',
                                iconSize: [30, 30]
                            })
                        }).addTo(map).bindPopup('Vous √™tes ici');

                        showToast('‚úÖ Carte centr√©e sur votre position');
                    },
                    (error) => {
                        console.error('Erreur g√©olocalisation:', error);
                        showToast('‚ö†Ô∏è G√©olocalisation non disponible');
                    }
                );
            }

            // Contr√¥les de dessin
            drawControl = new L.Control.Draw({
                draw: {
                    polygon: {
                        allowIntersection: false,
                        showArea: true,
                        metric: true
                    },
                    polyline: false,
                    rectangle: true,
                    circle: false,
                    marker: false,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            map.addControl(drawControl);

            // √âv√©nement quand une zone est cr√©√©e
            map.on(L.Draw.Event.CREATED, function (event) {
                const layer = event.layer;
                drawnItems.addLayer(layer);
                currentZone = layer;

                // Calculer les infos de la zone
                analyzeZone(layer);
            });

            mapInitialized = true;
        }

        function startDrawing() {
            if (!map) {
                showToast('‚ùå Carte non initialis√©e');
                return;
            }
            showToast('‚úèÔ∏è Dessinez votre zone sur la carte');
            new L.Draw.Polygon(map, drawControl.options.polygon).enable();
        }

        async function analyzeZone(layer) {
            const bounds = layer.getBounds();
            const center = bounds.getCenter();

            showToast('üîç Analyse de la zone...');

            // R√©cup√©rer les rues dans la zone
            const streets = await getStreetsInBounds(bounds);

            const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
            const areaKm2 = (area / 1000000).toFixed(2);

            // Estimation du nombre de portes (approximation: 100 portes/km¬≤)
            const estimatedDoors = Math.round(areaKm2 * 100);
            const estimatedHours = (estimatedDoors * 2 / 60).toFixed(1); // 2 min par porte

            showZoneInfo({
                area: areaKm2,
                streets: streets,
                estimatedDoors: estimatedDoors,
                estimatedHours: estimatedHours,
                bounds: bounds
            });
        }

        async function getStreetsInBounds(bounds) {
            try {
                const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
                const query = `
                    [out:json][timeout:25];
                    (
                        way["highway"]["name"](${bbox});
                    );
                    out body;
                    >;
                    out skel qt;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                const data = await response.json();
                const streetNames = new Set();

                data.elements.forEach(element => {
                    if (element.tags && element.tags.name) {
                        streetNames.add(element.tags.name);
                    }
                });

                return Array.from(streetNames);
            } catch (error) {
                console.error('Erreur Overpass API:', error);
                return [];
            }
        }

        function showZoneInfo(info) {
            const suggestionsDiv = document.getElementById('zoneSuggestions');

            let html = `
                <div class="zone-card">
                    <h4>üìä Analyse de la zone</h4>
                    <p><strong>Surface:</strong> ${info.area} km¬≤</p>
                    <p><strong>Rues d√©tect√©es:</strong> ${info.streets.length}</p>
                    <p><strong>Portes estim√©es:</strong> ${info.estimatedDoors}</p>
                    <p><strong>Temps estim√©:</strong> ${info.estimatedHours}h de boitage</p>
            `;

            if (info.streets.length > 0) {
                html += `
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; font-weight: 600;">Liste des rues (${info.streets.length})</summary>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            ${info.streets.map(street => `<li>${street}</li>`).join('')}
                        </ul>
                    </details>
                `;
            }

            html += `</div>`;
            suggestionsDiv.innerHTML = html;
        }

        async function optimizeCurrentZone() {
            if (!currentZone) {
                showToast('‚ùå Aucune zone s√©lectionn√©e');
                return;
            }

            showToast('‚ö° Optimisation en cours...');

            const bounds = currentZone.getBounds();
            const streets = await getStreetsInBounds(bounds);

            if (streets.length === 0) {
                showToast('‚ö†Ô∏è Aucune rue d√©tect√©e pour optimisation');
                return;
            }

            // Simuler une optimisation intelligente
            const suggestions = generateOptimizationSuggestions(streets, bounds);
            displayOptimizationSuggestions(suggestions);
        }

        function generateOptimizationSuggestions(streets, bounds) {
            const suggestions = [];

            // Suggestion 1: Retirer une rue pour optimiser
            if (streets.length > 3) {
                const randomStreet = streets[Math.floor(Math.random() * streets.length)];
                suggestions.push({
                    type: 'remove',
                    street: randomStreet,
                    reason: 'Cette rue est excentr√©e et augmente inutilement le temps de trajet',
                    timeSaved: '15-20 minutes'
                });
            }

            // Suggestion 2: Ajouter une rue adjacente
            suggestions.push({
                type: 'add',
                street: 'Rue adjacente sugg√©r√©e',
                reason: 'Cette rue est proche et permettrait de compl√©ter la zone de mani√®re coh√©rente',
                doorsAdded: '12-15 portes'
            });

            // Suggestion 3: Regrouper avec une zone voisine
            suggestions.push({
                type: 'merge',
                suggestion: 'Fusionner avec la zone nord',
                reason: 'Permettrait un parcours plus fluide et une meilleure couverture',
                efficiency: '+25%'
            });

            return suggestions;
        }

        function displayOptimizationSuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('zoneSuggestions');

            let html = `
                <div class="zone-suggestion">
                    <h5>üí° Suggestions d'optimisation</h5>
            `;

            suggestions.forEach((suggestion, index) => {
                if (suggestion.type === 'remove') {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 8px;">
                            <strong>‚ûñ Retirer: ${suggestion.street}</strong>
                            <p style="font-size: 0.9em; margin: 5px 0 0 0;">${suggestion.reason}</p>
                            <p style="font-size: 0.85em; color: #38ef7d; margin: 3px 0 0 0;">‚è±Ô∏è Gain: ${suggestion.timeSaved}</p>
                            <button class="btn btn-small btn-warning" style="margin-top: 8px;" onclick="applyOptimization(${index})">
                                Appliquer
                            </button>
                        </div>
                    `;
                } else if (suggestion.type === 'add') {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 8px;">
                            <strong>‚ûï Ajouter: ${suggestion.street}</strong>
                            <p style="font-size: 0.9em; margin: 5px 0 0 0;">${suggestion.reason}</p>
                            <p style="font-size: 0.85em; color: #667eea; margin: 3px 0 0 0;">üè† ${suggestion.doorsAdded}</p>
                            <button class="btn btn-small btn-success" style="margin-top: 8px;" onclick="applyOptimization(${index})">
                                Appliquer
                            </button>
                        </div>
                    `;
                } else if (suggestion.type === 'merge') {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: #f3e5f5; border-radius: 8px;">
                            <strong>üîó ${suggestion.suggestion}</strong>
                            <p style="font-size: 0.9em; margin: 5px 0 0 0;">${suggestion.reason}</p>
                            <p style="font-size: 0.85em; color: #764ba2; margin: 3px 0 0 0;">üìà Efficacit√©: ${suggestion.efficiency}</p>
                            <button class="btn btn-small btn-primary" style="margin-top: 8px;" onclick="applyOptimization(${index})">
                                Appliquer
                            </button>
                        </div>
                    `;
                }
            });

            html += `</div>`;
            suggestionsDiv.innerHTML += html;
            showToast('‚úÖ Suggestions g√©n√©r√©es');
        }

        function applyOptimization(index) {
            showToast('‚úÖ Optimisation appliqu√©e (fonctionnalit√© de d√©monstration)');
        }

        function showCityDivision() {
            const panel = document.getElementById('cityDivisionPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        async function divideCity() {
            const cityName = document.getElementById('cityNameInput').value.trim();
            const hoursPerZone = parseFloat(document.getElementById('hoursPerZone').value);

            if (!cityName) {
                showToast('‚ùå Veuillez entrer un nom de ville');
                return;
            }

            showToast('üîç Recherche de la ville...');

            try {
                // Chercher la ville via Nominatim
                const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(cityName)}&country=France&format=json&limit=1`);
                const data = await response.json();

                if (data.length === 0) {
                    showToast('‚ùå Ville non trouv√©e');
                    return;
                }

                const city = data[0];
                const lat = parseFloat(city.lat);
                const lon = parseFloat(city.lon);

                // Centrer la carte sur la ville
                map.setView([lat, lon], 13);

                showToast('üßÆ Calcul du d√©coupage intelligent...');

                // R√©cup√©rer les limites de la ville
                const bounds = await getCityBounds(city.osm_id, city.osm_type);

                // Calculer le nombre de zones n√©cessaires
                const cityArea = calculateArea(bounds);
                const doorsPerHour = 30; // 30 portes par heure
                const doorsPerZone = doorsPerHour * hoursPerZone;
                const doorsPerKm2 = 100; // Estimation
                const totalDoors = cityArea * doorsPerKm2;
                const numZones = Math.ceil(totalDoors / doorsPerZone);

                // Cr√©er les zones
                displayCityDivision(cityName, bounds, numZones, hoursPerZone);

            } catch (error) {
                console.error('Erreur:', error);
                showToast('‚ùå Erreur lors de l\'analyse');
            }
        }

        async function getCityBounds(osmId, osmType) {
            try {
                const type = osmType === 'node' ? 'node' : osmType === 'way' ? 'way' : 'relation';
                const response = await fetch(`https://nominatim.openstreetmap.org/lookup?osm_ids=${type[0].toUpperCase()}${osmId}&format=json&polygon_geojson=1`);
                const data = await response.json();

                if (data.length > 0 && data[0].geojson) {
                    const geojson = data[0].geojson;
                    const layer = L.geoJSON(geojson);
                    layer.addTo(map);
                    return layer.getBounds();
                }
            } catch (error) {
                console.error('Erreur r√©cup√©ration bounds:', error);
            }
            return null;
        }

        function calculateArea(bounds) {
            if (!bounds) return 0;
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            const width = L.latLng(ne.lat, ne.lng).distanceTo(L.latLng(ne.lat, sw.lng));
            const height = L.latLng(ne.lat, sw.lng).distanceTo(L.latLng(sw.lat, sw.lng));
            return (width * height) / 1000000; // en km¬≤
        }

        function displayCityDivision(cityName, bounds, numZones, hoursPerZone) {
            const zonesList = document.getElementById('zonesList');

            // Cr√©er une grille de zones sur la carte
            if (bounds) {
                const colors = ['#667eea', '#11998e', '#f5576c', '#fdb913', '#764ba2', '#00c9ff'];
                const gridCols = Math.ceil(Math.sqrt(numZones));
                const gridRows = Math.ceil(numZones / gridCols);

                const latStep = (bounds.getNorth() - bounds.getSouth()) / gridRows;
                const lngStep = (bounds.getEast() - bounds.getWest()) / gridCols;

                let zoneIndex = 0;
                for (let row = 0; row < gridRows && zoneIndex < numZones; row++) {
                    for (let col = 0; col < gridCols && zoneIndex < numZones; col++) {
                        const zoneBounds = [
                            [bounds.getSouth() + row * latStep, bounds.getWest() + col * lngStep],
                            [bounds.getSouth() + (row + 1) * latStep, bounds.getWest() + (col + 1) * lngStep]
                        ];

                        const rectangle = L.rectangle(zoneBounds, {
                            color: colors[zoneIndex % colors.length],
                            weight: 2,
                            fillOpacity: 0.2
                        }).addTo(map);

                        rectangle.bindPopup(`<strong>Zone ${zoneIndex + 1}</strong><br>${hoursPerZone}h de boitage`);

                        zoneIndex++;
                    }
                }
            }

            let html = `
                <div class="zone-card">
                    <h4>üèôÔ∏è D√©coupage de ${cityName}</h4>
                    <p><strong>Nombre de zones:</strong> ${numZones}</p>
                    <p><strong>Temps par zone:</strong> ${hoursPerZone}h</p>
                    <p><strong>Temps total estim√©:</strong> ${(numZones * hoursPerZone).toFixed(1)}h</p>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        Les zones ont √©t√© cr√©√©es sur la carte. Chaque zone repr√©sente environ ${hoursPerZone}h de boitage.
                    </p>
                    <button class="btn btn-success" style="margin-top: 10px;" onclick="exportZones()">
                        üì• Exporter les zones
                    </button>
                </div>
            `;

            zonesList.innerHTML = html;
            showToast(`‚úÖ ${numZones} zones cr√©√©es`);
        }

        function exportZones() {
            showToast('üì• Export des zones (fonctionnalit√© √† venir)');
        }

        // ==================== FIREBASE & TRACKING ====================
        let currentUser = null;
        let userProfile = null;

        // Initialiser l'authentification au chargement
        async function initAuth() {
            // V√©rifier si Firebase est configur√©
            if (typeof initFirebase === 'function') {
                initFirebase();

                // V√©rifier l'authentification
                currentUser = await checkAuth();

                if (!currentUser) {
                    // Rediriger vers login si pas connect√©
                    window.location.href = 'login.html';
                    return false;
                }

                // R√©cup√©rer le profil
                userProfile = await getUserProfile(currentUser.uid);

                if (!userProfile) {
                    alert('Profil utilisateur non trouv√©');
                    window.location.href = 'login.html';
                    return false;
                }

                // Afficher les infos utilisateur
                document.getElementById('userInfo').textContent =
                    `üë§ ${userProfile.name || currentUser.email}`;

                // Mettre √† jour l'activit√©
                await updateUserActivity();

                console.log('‚úÖ Authentification r√©ussie:', userProfile.name);
                return true;
            } else {
                // Mode local sans authentification
                console.log('‚ö†Ô∏è Mode local - Firebase non configur√©');
                document.querySelector('.header-user').style.display = 'none';
                return true;
            }
        }

        async function updateUserActivity() {
            if (!currentUser || !db) return;

            try {
                await db.collection('users').doc(currentUser.uid).update({
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Erreur mise √† jour activit√©:', error);
            }
        }

        // Tracker une activit√©
        async function trackActivity(action, address, additionalData = {}) {
            if (!currentUser || !db) {
                console.log('Tracking local:', action, address);
                return;
            }

            try {
                const activity = {
                    userId: currentUser.uid,
                    userName: userProfile?.name || currentUser.email,
                    action: action,
                    address: address,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ...additionalData
                };

                await db.collection('activities').add(activity);
                console.log('‚úÖ Activit√© track√©e:', action);
            } catch (error) {
                console.error('Erreur tracking:', error);
            }
        }

        // Modifier setStatus pour tracker
        const originalSetStatus = setStatus;
        setStatus = function(noteKey, status, index) {
            originalSetStatus(noteKey, status, index);

            // Tracker l'action
            const dpe = filteredData[index];
            if (dpe) {
                trackActivity(status, dpe.adresse_brut, {
                    city: dpe.commune,
                    postalCode: dpe.code_postal_brut,
                    latitude: null, // √Ä ajouter si disponible
                    longitude: null
                });
            }
        };

        // Modifier saveNote pour tracker
        const originalSaveNote = saveNote;
        saveNote = function(noteKey, comment, index) {
            originalSaveNote(noteKey, comment, index);

            // Tracker la note
            if (comment.trim()) {
                const dpe = filteredData[index];
                if (dpe) {
                    trackActivity('note', dpe.adresse_brut, {
                        note: comment,
                        city: dpe.commune
                    });
                }
            }
        };

        // Synchroniser les notes avec Firebase
        async function syncNotes() {
            if (!currentUser || !db) return;

            try {
                const notesData = {
                    userId: currentUser.uid,
                    notes: dpeNotes,
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('userNotes').doc(currentUser.uid).set(notesData, { merge: true });
                console.log('‚úÖ Notes synchronis√©es');
            } catch (error) {
                console.error('Erreur sync notes:', error);
            }
        }

        // Charger les notes depuis Firebase
        async function loadNotesFromCloud() {
            if (!currentUser || !db) return;

            try {
                const doc = await db.collection('userNotes').doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.notes) {
                        dpeNotes = data.notes;
                        localStorage.setItem('dpeNotes', JSON.stringify(dpeNotes));
                        updateNotesBadge();
                        console.log('‚úÖ Notes charg√©es depuis le cloud');
                    }
                }
            } catch (error) {
                console.error('Erreur chargement notes:', error);
            }
        }

        // Modifier saveNotes pour sync auto
        const originalSaveNotes = saveNotes;
        saveNotes = function() {
            originalSaveNotes();
            // Sync avec Firebase
            if (typeof syncNotes === 'function') {
                syncNotes();
            }
        };

        async function logout() {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                if (auth) {
                    await auth.signOut();
                }
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // Mettre √† jour l'activit√© toutes les 5 minutes
        if (typeof updateUserActivity === 'function') {
            setInterval(updateUserActivity, 300000);
        }

        console.log('‚úÖ DPE Pro v5.0 - Avec authentification et tracking');
        console.log('üìä Cache des communes:', communeCache);

        // Initialiser l'authentification au chargement
        window.addEventListener('load', async () => {
            const authOk = await initAuth();
            if (authOk && typeof loadNotesFromCloud === 'function') {
                await loadNotesFromCloud();
            }
        });
    </script>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <!-- Leaflet Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil@0.9.3/src/leaflet.geometryutil.js"></script>
</body>
</html>
