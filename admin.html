<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - DPE Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f7;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5em;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: white;
            color: #667eea;
        }

        .container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-card .subvalue {
            font-size: 0.9em;
            color: #999;
            margin-top: 5px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e5ea;
        }

        .users-table th {
            background: #f9f9f9;
            font-weight: 600;
            color: #333;
        }

        .users-table tr:hover {
            background: #f9f9f9;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-online {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-offline {
            background: #fce4ec;
            color: #c2185b;
        }

        .activity-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            margin-bottom: 12px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .activity-item .time {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 5px;
        }

        .activity-item .user {
            font-weight: 600;
            color: #667eea;
        }

        .activity-item .action {
            color: #333;
            margin-top: 5px;
        }

        #activityMap {
            height: 500px;
            border-radius: 12px;
            margin-top: 15px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters select,
        .filters input {
            padding: 10px 15px;
            border: 2px solid #e5e5ea;
            border-radius: 10px;
            font-size: 0.95em;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üë®‚Äçüíº Dashboard Administrateur</h1>
            <p style="font-size: 0.9em; opacity: 0.9; margin-top: 5px;" id="adminName">Admin</p>
        </div>
        <div class="header-info">
            <span id="lastUpdate">Derni√®re mise √† jour: --:--</span>
            <button class="btn-logout" onclick="logout()">üö™ D√©connexion</button>
        </div>
    </div>

    <div class="container">
        <!-- Statistiques globales -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üë• Commerciaux actifs</h3>
                <div class="value" id="activeUsers">0</div>
                <div class="subvalue">sur <span id="totalUsers">0</span> au total</div>
            </div>

            <div class="stat-card">
                <h3>üìç Adresses visit√©es</h3>
                <div class="value" id="totalVisits">0</div>
                <div class="subvalue">aujourd'hui</div>
            </div>

            <div class="stat-card">
                <h3>‚≠ê Prospects int√©ress√©s</h3>
                <div class="value" id="interestedCount">0</div>
                <div class="subvalue">cette semaine</div>
            </div>

            <div class="stat-card">
                <h3>üìä Taux de conversion</h3>
                <div class="value" id="conversionRate">0%</div>
                <div class="subvalue">en moyenne</div>
            </div>
        </div>

        <!-- Liste des commerciaux -->
        <div class="section">
            <h2>üë§ √âquipe commerciale</h2>

            <div class="filters">
                <select id="statusFilter" onchange="filterUsers()">
                    <option value="all">Tous les statuts</option>
                    <option value="online">En ligne</option>
                    <option value="offline">Hors ligne</option>
                </select>

                <button class="btn btn-success" onclick="exportAllData()">
                    üì• Exporter les donn√©es
                </button>
            </div>

            <div id="usersListContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Chargement des donn√©es...</p>
                </div>
            </div>
        </div>

        <!-- Activit√© en temps r√©el -->
        <div class="section">
            <h2>‚ö° Activit√© en temps r√©el</h2>

            <div class="filters">
                <select id="activityUserFilter" onchange="filterActivity()">
                    <option value="all">Tous les commerciaux</option>
                </select>

                <input type="date" id="activityDateFilter" onchange="filterActivity()">
            </div>

            <div id="activityList">
                <div class="empty-state">
                    <p>Aucune activit√© r√©cente</p>
                </div>
            </div>
        </div>

        <!-- Carte g√©ographique -->
        <div class="section">
            <h2>üó∫Ô∏è Carte des activit√©s</h2>
            <div id="activityMap"></div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let currentUser = null;
        let allUsers = [];
        let allActivities = [];
        let activityMap = null;

        // Initialiser
        async function init() {
            initFirebase();

            // V√©rifier l'authentification
            currentUser = await checkAuth();

            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // V√©rifier les droits admin
            const profile = await getUserProfile(currentUser.uid);

            if (!profile || profile.role !== 'admin') {
                alert('‚ùå Acc√®s refus√©: vous devez √™tre administrateur');
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('adminName').textContent = profile.name || currentUser.email;

            // Initialiser la carte
            initMap();

            // Charger les donn√©es
            await loadDashboardData();

            // √âcouter les changements en temps r√©el
            setupRealtimeListeners();

            // Mettre √† jour toutes les 30 secondes
            setInterval(updateLastUpdateTime, 30000);
            updateLastUpdateTime();
        }

        function initMap() {
            activityMap = L.map('activityMap').setView([48.8566, 2.3522], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(activityMap);
        }

        async function loadDashboardData() {
            try {
                // Charger les utilisateurs
                const usersSnapshot = await db.collection('users').where('role', '==', 'commercial').get();
                allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Charger les activit√©s
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const activitiesSnapshot = await db.collection('activities')
                    .where('timestamp', '>=', today)
                    .orderBy('timestamp', 'desc')
                    .limit(100)
                    .get();

                allActivities = activitiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Mettre √† jour l'affichage
                updateStats();
                displayUsers();
                displayActivities();
                updateActivityMap();

            } catch (error) {
                console.error('Erreur chargement donn√©es:', error);
            }
        }

        function setupRealtimeListeners() {
            // √âcouter les nouvelles activit√©s
            db.collection('activities')
                .orderBy('timestamp', 'desc')
                .limit(1)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const activity = { id: change.doc.id, ...change.doc.data() };
                            allActivities.unshift(activity);
                            displayActivities();
                            updateActivityMap();
                        }
                    });
                });

            // √âcouter les changements de statut des utilisateurs
            db.collection('users')
                .where('role', '==', 'commercial')
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified') {
                            const index = allUsers.findIndex(u => u.id === change.doc.id);
                            if (index !== -1) {
                                allUsers[index] = { id: change.doc.id, ...change.doc.data() };
                                displayUsers();
                            }
                        }
                    });
                });
        }

        function updateStats() {
            // Commerciaux actifs (connect√©s dans les 10 derni√®res minutes)
            const now = Date.now();
            const activeUsers = allUsers.filter(u =>
                u.lastActive && (now - u.lastActive.toMillis()) < 600000
            ).length;

            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('totalUsers').textContent = allUsers.length;

            // Adresses visit√©es aujourd'hui
            const visitsToday = allActivities.filter(a => a.action === 'visited').length;
            document.getElementById('totalVisits').textContent = visitsToday;

            // Prospects int√©ress√©s cette semaine
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const interestedThisWeek = allActivities.filter(a =>
                a.action === 'interested' &&
                a.timestamp &&
                a.timestamp.toDate() > weekAgo
            ).length;
            document.getElementById('interestedCount').textContent = interestedThisWeek;

            // Taux de conversion
            const totalVisits = allActivities.filter(a => a.action === 'visited').length;
            const interested = allActivities.filter(a => a.action === 'interested').length;
            const rate = totalVisits > 0 ? ((interested / totalVisits) * 100).toFixed(1) : 0;
            document.getElementById('conversionRate').textContent = rate + '%';
        }

        function displayUsers() {
            const container = document.getElementById('usersListContainer');
            const now = Date.now();

            if (allUsers.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Aucun commercial enregistr√©</p></div>';
                return;
            }

            let html = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>üë§ Commercial</th>
                            <th>üìß Email</th>
                            <th>üìä Statut</th>
                            <th>üìç Visites (7j)</th>
                            <th>‚≠ê Int√©ress√©s (7j)</th>
                            <th>‚è∞ Derni√®re activit√©</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allUsers.forEach(user => {
                const isOnline = user.lastActive && (now - user.lastActive.toMillis()) < 600000;
                const statusClass = isOnline ? 'status-online' : 'status-offline';
                const statusText = isOnline ? 'üü¢ En ligne' : 'üî¥ Hors ligne';

                // Calculer les stats de l'utilisateur
                const userActivities = allActivities.filter(a => a.userId === user.id);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);

                const visits = userActivities.filter(a =>
                    a.action === 'visited' &&
                    a.timestamp &&
                    a.timestamp.toDate() > weekAgo
                ).length;

                const interested = userActivities.filter(a =>
                    a.action === 'interested' &&
                    a.timestamp &&
                    a.timestamp.toDate() > weekAgo
                ).length;

                const lastActive = user.lastActive
                    ? formatRelativeTime(user.lastActive.toDate())
                    : 'Jamais';

                html += `
                    <tr>
                        <td><strong>${user.name || 'Sans nom'}</strong></td>
                        <td>${user.email}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${visits}</td>
                        <td>${interested}</td>
                        <td>${lastActive}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;

            // Mettre √† jour le filtre
            const userFilter = document.getElementById('activityUserFilter');
            const currentValue = userFilter.value;
            userFilter.innerHTML = '<option value="all">Tous les commerciaux</option>';
            allUsers.forEach(user => {
                userFilter.innerHTML += `<option value="${user.id}">${user.name || user.email}</option>`;
            });
            userFilter.value = currentValue;
        }

        function displayActivities() {
            const container = document.getElementById('activityList');

            if (allActivities.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Aucune activit√© r√©cente</p></div>';
                return;
            }

            let html = '';

            allActivities.slice(0, 20).forEach(activity => {
                const user = allUsers.find(u => u.id === activity.userId);
                const userName = user ? (user.name || user.email) : 'Utilisateur inconnu';

                const time = activity.timestamp
                    ? formatTime(activity.timestamp.toDate())
                    : 'Date inconnue';

                let actionText = '';
                let actionIcon = '';

                switch (activity.action) {
                    case 'visited':
                        actionIcon = '‚úÖ';
                        actionText = 'a visit√©';
                        break;
                    case 'interested':
                        actionIcon = '‚≠ê';
                        actionText = 'a marqu√© comme int√©ress√©';
                        break;
                    case 'not-interested':
                        actionIcon = '‚ùå';
                        actionText = 'a marqu√© comme non int√©ress√©';
                        break;
                    case 'note':
                        actionIcon = 'üìù';
                        actionText = 'a ajout√© une note sur';
                        break;
                    default:
                        actionIcon = 'üìç';
                        actionText = 'a interagi avec';
                }

                html += `
                    <div class="activity-item">
                        <div class="time">${time}</div>
                        <div class="action">
                            ${actionIcon} <span class="user">${userName}</span> ${actionText}
                            <strong>${activity.address || 'une adresse'}</strong>
                        </div>
                        ${activity.note ? `<div style="margin-top: 5px; font-size: 0.9em; color: #666;">Note: "${activity.note}"</div>` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateActivityMap() {
            // Effacer les anciens marqueurs
            activityMap.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    activityMap.removeLayer(layer);
                }
            });

            // Ajouter les nouveaux marqueurs
            allActivities.forEach(activity => {
                if (activity.latitude && activity.longitude) {
                    const user = allUsers.find(u => u.id === activity.userId);
                    const userName = user ? (user.name || user.email) : 'Utilisateur';

                    let markerColor = '#667eea';
                    if (activity.action === 'visited') markerColor = '#38ef7d';
                    if (activity.action === 'interested') markerColor = '#fdb913';

                    const marker = L.circleMarker([activity.latitude, activity.longitude], {
                        radius: 8,
                        fillColor: markerColor,
                        color: 'white',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(activityMap);

                    marker.bindPopup(`
                        <strong>${userName}</strong><br>
                        ${activity.address || 'Adresse inconnue'}<br>
                        <small>${formatTime(activity.timestamp.toDate())}</small>
                    `);
                }
            });

            // Ajuster la vue pour afficher tous les marqueurs
            if (allActivities.length > 0) {
                const group = new L.featureGroup(
                    allActivities
                        .filter(a => a.latitude && a.longitude)
                        .map(a => L.marker([a.latitude, a.longitude]))
                );
                if (group.getBounds().isValid()) {
                    activityMap.fitBounds(group.getBounds().pad(0.1));
                }
            }
        }

        function filterUsers() {
            displayUsers();
        }

        function filterActivity() {
            displayActivities();
        }

        function formatTime(date) {
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return '√Ä l\'instant';
            if (diff < 3600000) return `Il y a ${Math.floor(diff / 60000)} min`;
            if (diff < 86400000) return `Il y a ${Math.floor(diff / 3600000)}h`;

            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return '√Ä l\'instant';
            if (diff < 3600000) return `Il y a ${Math.floor(diff / 60000)} min`;
            if (diff < 86400000) return `Il y a ${Math.floor(diff / 3600000)}h`;
            if (diff < 604800000) return `Il y a ${Math.floor(diff / 86400000)}j`;

            return date.toLocaleDateString('fr-FR');
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent =
                `Derni√®re mise √† jour: ${now.toLocaleTimeString('fr-FR')}`;
        }

        async function exportAllData() {
            let csv = 'Commercial,Email,Action,Adresse,Date,Note\n';

            allActivities.forEach(activity => {
                const user = allUsers.find(u => u.id === activity.userId);
                const userName = user ? (user.name || user.email) : 'Inconnu';
                const userEmail = user ? user.email : '';
                const date = activity.timestamp ? activity.timestamp.toDate().toLocaleString('fr-FR') : '';
                const note = activity.note || '';

                csv += `"${userName}","${userEmail}","${activity.action}","${activity.address || ''}","${date}","${note}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `DPE_Admin_Export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        async function logout() {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                await auth.signOut();
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // Initialiser au chargement
        window.addEventListener('load', init);
    </script>
</body>
</html>
